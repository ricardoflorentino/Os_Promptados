<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unificador de Planilhas</title>
    <style>
        :root{
            --bg: #f6f8fb;
            --card: #ffffff;
            --primary: #2563eb;
            --primary-600: #1e40af;
            --muted: #6b7280;
            --accent: #eef2ff;
            --success: #0f5132;
            --danger: #7f1d1d;
            --radius: 12px;
            --shadow-soft: 0 6px 18px rgba(16,24,40,0.06);
            --shadow-strong: 0 12px 34px rgba(16,24,40,0.08);
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial;
        }
        html,body{height:100%;}
        body{
            margin:0;
            background: linear-gradient(180deg, var(--bg), #eef4ff 80%);
            display:flex;align-items:flex-start;justify-content:center;padding:48px 20px 80px;
            -webkit-font-smoothing:antialiased;
        }

        .wrap{
            width:100%;max-width:980px;
        }

        .header{
            display:flex;align-items:center;gap:14px;margin-bottom:18px;
        }
        .logo{
            width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg, rgba(37,99,235,0.12), rgba(37,99,235,0.04));display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--primary);box-shadow:var(--shadow-soft);
        }
        h1{margin:0;font-size:1.25rem;color:#0b1220}
        p.lead{margin:0;color:var(--muted);font-size:0.95rem}

        .container{
            background:var(--card);border-radius:16px;padding:18px;box-shadow:var(--shadow-strong);display:grid;grid-template-columns:1fr 300px;gap:20px;align-items:start;
        }
        @media (max-width:920px){.container{grid-template-columns:1fr;}}

        /* Left column */
        .card{background:linear-gradient(180deg,#fff, #fbfdff);border-radius:12px;padding:14px;border:1px solid rgba(15,23,42,0.03);}
        .dropzone{display:flex;gap:12px;align-items:center;padding:16px;border-radius:10px;border:1px dashed rgba(15,23,42,0.06);background:transparent;cursor:pointer;transition:all .14s ease}
        .dropzone:focus{outline:2px solid rgba(37,99,235,0.14);}
        .dropzone.dragover{background:var(--accent);border-color:var(--primary);transform:translateY(-2px);}
        .drop-icon{width:52px;height:52px;border-radius:8px;background:linear-gradient(180deg, rgba(37,99,235,0.08), rgba(37,99,235,0.02));display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--primary)}
        .drop-text{font-weight:600;color:#0f172a}
        .drop-sub{font-size:0.92rem;color:var(--muted);margin-top:4px}
        input[type=file]{position:absolute;opacity:0;pointer-events:none;height:1px;width:1px}

        .actions{display:flex;gap:10px;margin-top:12px}
        button.primary{background:var(--primary);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 8px 20px rgba(37,99,235,0.12)}
        button.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);padding:10px 12px;border-radius:10px;color:#0f172a;cursor:pointer}

        /* File list */
        .file-list{margin-top:14px;display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto;padding-right:6px}
        .file-item{display:flex;align-items:center;justify-content:space-between;background:#fbfcff;border:1px solid rgba(15,23,42,0.03);padding:10px;border-radius:10px}
        .file-item .meta{display:flex;flex-direction:column}
        .file-item .name{font-weight:700;color:#071033}
        .file-item .size{font-size:0.86rem;color:var(--muted);margin-top:4px}
        .badge{font-size:0.82rem;color:var(--muted)}
        .file-item:hover{transform:translateY(-3px);box-shadow:var(--shadow-soft)}

        /* Right column */
        aside{display:flex;flex-direction:column;gap:12px}
        aside .panel{background:transparent;padding:10px}
        aside .panel strong{display:block;color:#0b1220;margin-bottom:6px}
        .tips{color:var(--muted);font-size:0.92rem;line-height:1.45}

        /* Loading / messages */
        .loading{display:none;margin-top:12px;text-align:center}
        .spinner{width:40px;height:40px;border:5px solid #f1f5f9;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 8px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .success,.error{display:none;padding:10px;border-radius:10px;text-align:center}
        .success{background:#e8fdf3;color:var(--success);border:1px solid #c9f4d9}
        .error{background:#fff1f1;color:var(--danger);border:1px solid #ffd7d7}

        .meta{font-size:0.9rem;color:var(--muted);text-align:center;margin-top:6px}
        .file-count{font-size:0.9rem;color:var(--muted);text-align:right}

        /* small screens tweaks */
        @media (max-width:480px){.drop-text{font-size:1rem}.drop-sub{font-size:0.85rem}.logo{width:40px;height:40px}}
    </style>
</head>
<body>
    <div class="wrap">
        <div class="header">
            <div class="logo">üìÇ</div>
            <div>
                <h1>Unificador de Planilhas</h1>
                <p class="lead">Envie m√∫ltiplas planilhas e baixe a base unificada em CSV.</p>
            </div>
        </div>

        <div class="container">
            <div class="card">
                <form id="uploadForm" method="post" enctype="multipart/form-data">
                    <div class="card" style="margin-bottom:12px">
                        <label for="competencia" style="display:block;font-weight:700;color:#0b1220;margin-bottom:6px">1) Compet√™ncia (M√™s/Ano)</label>
                        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                            <input id="competencia" name="competencia" type="month" required aria-describedby="competenciaHelp" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(15,23,42,0.08)" />
                            <small id="competenciaHelp" class="meta">Informe o m√™s e ano de refer√™ncia antes do envio.</small>
                        </div>
                    </div>

                    <label id="dropZone" for="fileInput" class="dropzone" tabindex="0" aria-label="√Årea para arrastar e soltar arquivos">
                        <div class="drop-icon">üìÅ</div>
                        <div>
                            <div class="drop-text">2) Arraste e solte os arquivos aqui</div>
                            <div class="drop-sub">ou clique para selecionar (.xlsx, .xls, .csv)</div>
                        </div>
                        <input id="fileInput" type="file" name="planilhas[]" multiple required aria-describedby="fileListDesc">
                    </label>

                    <div class="file-count" id="fileCount">Nenhum arquivo selecionado</div>

                    <div class="file-list" id="fileList" aria-live="polite" aria-atomic="true">
                        <div id="fileListDesc" class="meta">Selecione at√© 20 arquivos de uma vez</div>
                    </div>

                    <div class="actions">
                        <button id="submitBtn" type="submit" class="primary">Enviar e Processar</button>
                        <button type="button" class="ghost" id="clearBtn">Limpar</button>
                    </div>

                    <div id="loading" class="loading" aria-live="polite">
                        <div class="spinner" role="status" aria-label="Carregando"></div>
                        <div>Processando seus arquivos... Isso pode levar alguns minutos.</div>
                    </div>

                    <div id="success" class="success" role="status" aria-live="polite">‚úÖ Conclu√≠do! O download foi iniciado.
                        <div style="margin-top:8px"><button class="ghost" type="button" onclick="location.reload()">Nova execu√ß√£o</button></div>
                    </div>
                    <div id="error" class="error" role="alert"></div>
                </form>
            </div>

            <aside>
                <div class="panel card">
                    <strong>Como funciona</strong>
                    <div class="tips">O sistema unifica diferentes bases (admiss√£o, afastamentos, f√©rias, etc.) e gera um CSV pronto para download.</div>
                </div>
                <div class="panel card">
                    <strong>Dicas r√°pidas</strong>
                    <ul class="tips" style="margin:6px 0 0 18px;padding:0;line-height:1.6">
                        <li>Mantenha os cabe√ßalhos consistentes entre arquivos.</li>
                        <li>Remova colunas desnecess√°rias antes do envio.</li>
                        <li>Arquivos muito grandes podem levar mais tempo.</li>
                    </ul>
                </div>
            </aside>
        </div>
    </div>

    <script>
        (function() {
            const form = document.getElementById('uploadForm');
            const fileInput = document.getElementById('fileInput');
            const competenciaInput = document.getElementById('competencia');
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const success = document.getElementById('success');
            const errorBox = document.getElementById('error');
            const fileList = document.getElementById('fileList');
            const dropZone = document.getElementById('dropZone');
            const clearBtn = document.getElementById('clearBtn');
            const fileCount = document.getElementById('fileCount');

            function humanSize(bytes){
                if(!bytes) return '';
                const kb = 1024;
                if(bytes < kb) return bytes + ' B';
                if(bytes < kb*1024) return Math.round(bytes/kb) + ' KB';
                return Math.round(bytes/(kb*kb)) + ' MB';
            }

            function renderFileList(files){
                fileList.innerHTML = '';
                const count = (files && files.length) ? files.length : 0;
                fileCount.textContent = count ? (count + ' arquivo' + (count>1 ? 's' : '') + ' selecionado' + (count>1 ? 's' : '')) : 'Nenhum arquivo selecionado';

                if(!files || files.length === 0){
                    const desc = document.createElement('div');
                    desc.id = 'fileListDesc';
                    desc.className = 'meta';
                    desc.textContent = 'Selecione at√© 20 arquivos de uma vez';
                    fileList.appendChild(desc);
                    return;
                }

                for(let i=0;i<files.length;i++){
                    const f = files[i];
                    const row = document.createElement('div');
                    row.className = 'file-item';

                    const meta = document.createElement('div');
                    meta.className = 'meta';
                    const name = document.createElement('div');
                    name.className = 'name';
                    name.textContent = f.name;
                    const size = document.createElement('div');
                    size.className = 'size';
                    size.textContent = humanSize(f.size);
                    meta.appendChild(name);
                    meta.appendChild(size);

                    const badge = document.createElement('div');
                    badge.className = 'badge';
                    badge.textContent = 'Arquivo ' + (i+1);

                    row.appendChild(meta);
                    row.appendChild(badge);
                    fileList.appendChild(row);
                }
            }

            async function handleSubmit(e) {
                e.preventDefault();
                if (!competenciaInput || !competenciaInput.value) {
                    errorBox.textContent = 'Informe a Compet√™ncia (m√™s/ano).';
                    errorBox.style.display = 'block';
                    return;
                }
                if (!fileInput || !fileInput.files || fileInput.files.length === 0) return;

                // UI: show loading, hide inputs
                // keep input visually hidden but still present for backend
                if (dropZone) dropZone.classList.remove('dragover');
                loading.style.display = 'block';
                errorBox.style.display = 'none';
                success.style.display = 'none';
                submitBtn.disabled = true;

                try {
                    const resp = await fetch(form.action || window.location.pathname, {
                        method: 'POST',
                        body: new FormData(form)
                    });

                    if (!resp.ok) {
                        const txt = await resp.text();
                        throw new Error(txt || ('Erro HTTP ' + resp.status));
                    }

                    const cd = resp.headers.get('content-disposition') || '';
                    let filename = 'resultado.csv';
                    const m = /filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(cd);
                    if (m) {
                        filename = decodeURIComponent(m[1] || m[2] || filename);
                    }

                    const blob = await resp.blob();
                    const type = (blob && blob.type) ? blob.type : '';
                    if (type.includes('text/html')) {
                        const text = await blob.text();
                        throw new Error('N√£o foi poss√≠vel gerar o arquivo.');
                    }

                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);

                    loading.style.display = 'none';
                    success.style.display = 'block';
                } catch (err) {
                    loading.style.display = 'none';
                    errorBox.textContent = (err && err.message) ? err.message : 'Ocorreu um erro ao processar.';
                    errorBox.style.display = 'block';
                } finally {
                    submitBtn.disabled = false;
                }
            }

            // events
            fileInput.addEventListener('change', function(){ renderFileList(fileInput.files); });

            ['dragenter','dragover'].forEach(ev => {
                dropZone.addEventListener(ev, function(e){
                    e.preventDefault(); e.stopPropagation();
                    dropZone.classList.add('dragover');
                });
            });
            ['dragleave','drop'].forEach(ev => {
                dropZone.addEventListener(ev, function(e){
                    e.preventDefault(); e.stopPropagation();
                    if(ev === 'drop'){
                        const dt = e.dataTransfer;
                        if(dt && dt.files && dt.files.length){
                            try{ fileInput.files = dt.files; } catch(ex){
                                const dataTransfer = new DataTransfer();
                                for(let i=0;i<dt.files.length;i++){ dataTransfer.items.add(dt.files[i]); }
                                fileInput.files = dataTransfer.files;
                            }
                            renderFileList(fileInput.files);
                        }
                    }
                    dropZone.classList.remove('dragover');
                });
            });

            if (form) { form.addEventListener('submit', handleSubmit); }

            clearBtn.addEventListener('click', function(){ fileInput.value = ''; renderFileList([]); });

            // initial render
            renderFileList(fileInput.files);

        })();
    </script>
</body>
</html>